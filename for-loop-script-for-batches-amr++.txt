#Combining and Clean AMRPlusPlus output
#Sophia Kenney 

#load packages----
library(BiocManager)
library(plyr)
library(dplyr)
library(stringr)
library(rlist)

#read in and clean data----
files<- Sys.glob("app-output/*.csv")

for (i in files) {
  filename <-str_split_fixed(str_split_fixed(paste0(i), "-", 3)[,3], ".csv", 2)[1]
  wd <- paste0(i)
  assign(filename, read.csv(wd))
}

dat <- lapply(Sys.glob("app-output/*.csv"), read.csv)
bovnames <- ls(pattern = "bov")
humnames <- ls(pattern = "hum")
batchnames <- list.append(bovnames, humnames)
filename2 <- paste(batchnames, ".2", sep = "")

for (i in 1:length(dat)) {
  assign(filename2[i], 
         cbind(as.data.frame(dat[i]), as.data.frame(str_split_fixed(rownames(as.data.frame(dat[i])), "\\|", 5))[5])%>% #extract gene name from amr++ output and add to count matrix
           aggregate(.~V5, FUN= sum))
}


#combine all matrices by gene ----

merged <- join_all(mget(grep(pattern = ".2", names(.GlobalEnv), value = TRUE, fixed = TRUE)), by = "V5", type = "full") %>% replace(., is.na(.), 0)
rownames(merged) <- merged$V5 #fix rownames so that they are the gene name
#colnames(merged) <- trimws(colnames(merged), whitespace = "_.*") #fix colnames to drop file extension
merged_clean <- merged[2:ncol(merged)] #drop the gene name column so that its a count matrix with genes as rows and samples as columns

write.table(merged_clean, file = "tables/countmatrix-cleanedall.txt", sep = "\t") #save this matrix


#break up gene information for alllll batches (batch1 - batch n) - this will be useful for later ----
genes <- data.frame()

for (i in 1:length(dat)) {
  genes <- rbind(genes, do.call(rbind, as.list(rownames(dat[[i]])))) %>% #add all rownames togther as a single column df
  unique() #remove redunant rows
}

colnames(genes)[1] <- "allmeg" #fix column name
genes <- as.data.frame(str_split_fixed(genes$allmeg, "\\|", 5)) #break up gene info
colnames(genes) <- c("MEG_ID", "Broadclass", "Class", "Mechanism", "Gene") #fix column names 

write.table(genes, file = "tables/geneinfo-all.txt", sep = "\t") #save this for later

#save work ----
save.image("rdata/wrangling.RData")